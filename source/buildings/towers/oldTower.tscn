[gd_scene load_steps=8 format=3 uid="uid://cm6gs5khniahl"]

[ext_resource type="Shader" uid="uid://cqp60r1dbqwv6" path="res://source/shaders/outline_shader.gdshader" id="1_ckacg"]
[ext_resource type="Texture2D" uid="uid://dfi0lgur668l5" path="res://assets/tiny_swords/Factions/Knights/Buildings/Tower/Tower_Blue.png" id="2_vwnkc"]
[ext_resource type="PackedScene" uid="uid://bkpc2ohp4v5yw" path="res://source/projectiles/targetting_system.tscn" id="4_v2hj7"]
[ext_resource type="PackedScene" uid="uid://c2novouetbqvt" path="res://source/projectiles/shooting_system.tscn" id="5_jvexm"]

[sub_resource type="ShaderMaterial" id="ShaderMaterial_xpe70"]
shader = ExtResource("1_ckacg")
shader_parameter/color = Color(0.105882, 1, 0.109804, 1)
shader_parameter/width = 4.0
shader_parameter/pattern = 0
shader_parameter/inside = false
shader_parameter/add_margins = true

[sub_resource type="GDScript" id="GDScript_tvqtj"]
script/source = "class_name OldTower
extends Sprite2D

signal upgrade_requested


var building_stats: TowerStats = TowerStats.new()
var arrow_stats: ArrowStats = building_stats.arrow_stats


# targeting
var target: Vector2

@onready var hitbox: Area2D = $Hitbox
@onready var hitbox_shape: CollisionShape2D = $Hitbox/HitboxShape
@onready var tower_click: TextureButton = $TowerClick
@onready var hover_shader: Material = material
@onready var targetting_system: TargettingSystem = $TargettingSystem
@onready var shooting_system: ShootingSystem = $ShootingSystem


func _ready() -> void:
	set_building_stats()
	material = null
	
	# connect signals
	tower_click.pressed.connect(on_upgrade_requested)
	tower_click.mouse_entered.connect(on_tower_hovered_in)
	tower_click.mouse_exited.connect(on_tower_hovered_out)


func _process(_delta: float) -> void:
	if len(targetting_system.target_list) > 0 and not shooting_system.projectile_on_cd:
		target = targetting_system.lock_target()
		shooting_system.shoot(arrow_stats, target)

func set_building_stats() -> void:
	targetting_system.update_range(building_stats.get_tower_range())

func on_upgrade_requested() -> void:
	upgrade_requested.emit(self)

func on_tower_hovered_in() -> void:
	material = hover_shader
	
func on_tower_hovered_out() -> void:
	material = null
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_xkfnw"]
size = Vector2(128, 128)

[node name="Tower" type="Sprite2D" groups=["buildings"]]
z_index = 1
material = SubResource("ShaderMaterial_xpe70")
position = Vector2(64, 0)
texture = ExtResource("2_vwnkc")
script = SubResource("GDScript_tvqtj")

[node name="Hitbox" type="Area2D" parent="."]
collision_layer = 16
collision_mask = 16

[node name="HitboxShape" type="CollisionShape2D" parent="Hitbox"]
position = Vector2(0, 64.5)
shape = SubResource("RectangleShape2D_xkfnw")

[node name="TowerClick" type="TextureButton" parent="."]
offset_left = -64.0
offset_top = -85.0
offset_right = 64.0
offset_bottom = 117.0
mouse_filter = 1

[node name="TargettingSystem" parent="." instance=ExtResource("4_v2hj7")]

[node name="ShootingSystem" parent="." instance=ExtResource("5_jvexm")]
